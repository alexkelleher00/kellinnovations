<div class="wrap">
  <header>
    <h1>Community Posts</h1>
    <p>Share a title, your message, and sign your name.</p>
    <a href="https://kellinnovations.com">← Back to Website</a>
  </header>

  <form id="postForm">
    <label>Title
      <input type="text" id="title" maxlength="200" required />
    </label>

    <label>Your Name (displayed)
      <input type="text" id="name" maxlength="100" placeholder="Optional" />
    </label>

    <label>Message
      <textarea id="content" rows="6" maxlength="5000" required></textarea>
    </label>

    <button type="submit">Publish</button>
    <div id="formMsg" class="msg"></div>
  </form>

  <label style="display:block;margin-top:12px;">
    Admin Key (optional, to delete posts):
    <input type="password" id="adminKey" placeholder="Enter admin key to enable deletion" />
  </label>

  <section class="posts">
    <h2>Recent Posts</h2>
    <div id="postsList">Loading...</div>
  </section>
</div>

<style>
  :root{--accent:#0077cc;--muted:#666;--bg:#f7f8fa;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:900px;margin:30px auto;padding:16px}
  header{background:#fff;padding:18px;border-radius:8px;border:1px solid #eee}
  h1{margin:0}
  form{margin-top:12px;background:#fff;padding:16px;border-radius:8px;border:1px solid #eee}
  input, textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-top:6px;box-sizing:border-box}
  label{font-weight:600;display:block;margin-top:10px}
  button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;margin-top:12px}
  .posts{margin-top:18px}
  .post{background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;margin-bottom:10px}
  .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .msg{margin-top:8px;color:var(--muted)}
  .deleteBtn{background:#c33;color:#fff;padding:4px 8px;border-radius:4px;border:0;cursor:pointer;margin-top:6px;}
</style>

<script>
const API_BASE = "https://communicate-characteristics-gratuit-les.trycloudflare.com/blog";
const API_POSTS = API_BASE + "/api/posts";

const postsList = document.getElementById("postsList");
const form = document.getElementById("postForm");
const formMsg = document.getElementById("formMsg");
const adminInput = document.getElementById("adminKey");

function escapeHtml(unsafe) {
  return unsafe
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

async function loadPosts() {
  
  try {
    const res = await fetch(API_POSTS);
    console.log(res); // <--- debug
    if (!res.ok) throw new Error("Network error");
    const posts = await res.json();
    console.log(posts); // <--- debug
    renderPosts(posts);
  } catch (e) {
    console.error(e);
    postsList.innerHTML = "<p style='color:#c33'>Unable to load posts.</p>";
  }
}

function renderPosts(posts) {
  const adminKey = adminInput.value.trim();
  if (!posts || posts.length === 0) {
    postsList.innerHTML = "<p>No posts yet — be the first!</p>";
    return;
  }
  postsList.innerHTML = posts.map(p => {
    const title = escapeHtml(p.title);
    const content = escapeHtml(p.content).replaceAll("\n","<br>");
    const name = escapeHtml(p.name || "Anonymous");
    const created = new Date(p.created_at).toLocaleString();

    let deleteBtn = "";
    if (adminKey) {
      deleteBtn = `<button class="deleteBtn" onclick="deletePost(${p.id})">Delete</button>`;
    }

    return `
      <article class="post">
        <h3>${title}</h3>
        <div class="meta">by ${name} · ${created}</div>
        <div class="body">${content}</div>
        ${deleteBtn}
      </article>
    `;
  }).join("");
}

form.addEventListener("submit", async (ev) => {
  ev.preventDefault();
  formMsg.textContent = "";
  const title = document.getElementById("title").value.trim();
  const name = document.getElementById("name").value.trim() || "Anonymous";
  const content = document.getElementById("content").value.trim();

  if (!title || !content) {
    formMsg.textContent = "Please add a title and message.";
    return;
  }

  try {
    const res = await fetch(API_POSTS, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({title, name, content})
    });

    if (res.status === 429) {
      formMsg.textContent = "You are posting too frequently. Try again later.";
      return;
    }

    if (!res.ok) {
      const err = await res.json().catch(()=>({error:"Post failed"}));
      formMsg.textContent = err.error || "Failed to post.";
      return;
    }

    form.reset();
    formMsg.textContent = "Posted!";
    loadPosts();
  } catch (e) {
    formMsg.textContent = "Network error while posting.";
  }
});

// -----------------------
// Admin delete function
// -----------------------
async function deletePost(postId) {
  const adminKey = adminInput.value.trim();
  if (!adminKey) {
    alert("Admin key required to delete posts");
    return;
  }
  if (!confirm("Are you sure you want to delete this post?")) return;

  try {
    const res = await fetch(`${API_POSTS}/${postId}`, {
      method: "DELETE",
      headers: { "X-Admin-Key": adminKey }
    });
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:"Delete failed"}));
      alert(err.error || "Failed to delete post");
      return;
    }
    loadPosts();
  } catch (e) {
    alert("Network error while deleting.");
  }
}

// Refresh posts whenever admin key changes
adminInput.addEventListener("input", loadPosts);

// initial load
loadPosts();
</script>
